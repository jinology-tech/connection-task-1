<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>과제 1: 개념 배치·연결</title>
  <style>
    *{box-sizing:border-box} body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;margin:0}
    header{background:#111827;color:#e5e7eb;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #1f2937}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{background:#0b1323;border:1px solid #374151;color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#60a5fa}
    .container{display:flex;height:calc(100vh - 56px)}
    .panel{width:280px;background:#e2e8f0;padding:12px;overflow:auto;border-right:1px solid #cbd5e1}
    .concept{background:#2563eb;color:#fff;padding:8px 12px;margin:6px 0;border-radius:999px;cursor:grab;text-align:center;font-weight:600;user-select:none}
    .concept.disabled{background:#94a3b8;cursor:not-allowed;opacity:.7}
    .canvas{flex:1;position:relative;background:#f8fafc}
    .placed{position:absolute;background:#e11d48;color:#fff;padding:6px 10px;border-radius:12px;cursor:pointer;user-select:none;font-weight:600;outline-offset:2px}
    svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
    line.connection{stroke:#334155;stroke-width:2;pointer-events:all;cursor:pointer}
    #count{font-size:14px;color:#9ca3af}
    .hint{font-size:12px;color:#64748b;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div><strong>과제 1: 개념 배치·연결</strong></div>
    <div class="toolbar">
      <span id="count">현재 연결 수: 0</span>
      <button class="btn" id="toggleConnect">연결 모드: 꺼짐</button>
      <button class="btn" id="resetBtn">초기화</button>
    </div>
  </header>

  <div class="container">
    <div class="panel">
      <div id="panel"></div>
      <div class="hint">* 개념은 한 번만 사용할 수 있습니다.<br>* 캔버스에서 개념을 선택하고 Delete(또는 Backspace) 키로 삭제할 수 있습니다.</div>
    </div>
    <div class="canvas" id="canvas">
      <svg id="svg"></svg>
    </div>
  </div>

<script>
const CONCEPTS = ['자연수', '분수', '소수', '덧셈', '뺄셈', '곱셈', '나눗셈', '평면도형', '입체도형', '길이', '둘레', '부피', '넓이', '겉넓이'];
const panel = document.getElementById("panel");
const canvas = document.getElementById("canvas");
const svg = document.getElementById("svg");
const countEl = document.getElementById("count");
const toggleBtn = document.getElementById("toggleConnect");
const resetBtn = document.getElementById("resetBtn");

let connectMode = false;
let dragged = null;
let placed = [];      // {id, concept, x, y}
let selected = [];    // [nodeIds]
let connections = []; // {id, a, b}
let used = new Set(); // 사용된 개념(1회 사용)
let connId = 1;

// 패널 렌더링
function renderPanel(){
  panel.innerHTML = "";
  CONCEPTS.forEach(c=>{
    const div = document.createElement("div");
    div.className = "concept" + (used.has(c) ? " disabled" : "");
    div.textContent = c;
    if(!used.has(c)) {
      div.draggable = true;
      div.addEventListener("dragstart", e=>{ dragged = c; });
    }
    panel.appendChild(div);
  });
}
renderPanel();

// 드롭하여 배치
canvas.addEventListener("dragover", e => e.preventDefault());
canvas.addEventListener("drop", e => {
  e.preventDefault();
  if (!dragged || used.has(dragged)) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const id = Date.now() + Math.floor(Math.random()*1000);
  const tag = { id, concept: dragged, x, y };
  placed.push(tag);
  used.add(dragged);     // 1회 사용 처리
  addPlacedDOM(tag);
  dragged = null;
  renderPanel();         // 패널 갱신(회색 처리)
});

// 배치된 태그 DOM 추가
function addPlacedDOM(tag){
  const div = document.createElement("div");
  div.className = "placed";
  div.textContent = tag.concept;
  div.style.left = (tag.x - 40) + "px";
  div.style.top  = (tag.y - 15) + "px";
  div.dataset.id = tag.id;
  div.addEventListener("click", () => onPlacedClick(tag.id, div));
  canvas.appendChild(div);
}

// 배치된 태그 클릭(선택 토글 + 연결 처리)
function onPlacedClick(id, el){
  if (selected.includes(id)) {
    selected = selected.filter(s => s !== id);
    el.style.outline = "";
  } else {
    selected.push(id);
    el.style.outline = "2px solid #60a5fa";
  }
  if (connectMode && selected.length === 2) {
    createConnection(selected[0], selected[1]);
    // 선택 초기화
    selected = [];
    document.querySelectorAll(".placed").forEach(n => n.style.outline = "");
  }
}

// 연결 생성
function createConnection(aId, bId){
  if (aId === bId) return;
  if (connections.some(c => (c.a===aId && c.b===bId) || (c.a===bId && c.b===aId))) return;

  const a = placed.find(p => p.id === aId);
  const b = placed.find(p => p.id === bId);
  if (!a || !b) return;

  const id = connId++;
  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", a.x);
  line.setAttribute("y1", a.y);
  line.setAttribute("x2", b.x);
  line.setAttribute("y2", b.y);
  line.classList.add("connection");
  line.dataset.id = id;

  // 연결선 클릭 삭제 (연결 모드 ON일 때만)
  line.addEventListener("click", () => {
    if (!connectMode) return;
    removeConnection(id);
  });

  svg.appendChild(line);
  connections.push({ id, a: aId, b: bId });
  updateCount();
}

// 해당 연결만 삭제
function removeConnection(id){
  const el = svg.querySelector('line.connection[data-id="' + id + '"]');
  if (el) el.remove();
  connections = connections.filter(c => c.id !== id);
  updateCount();
}

// 연결 수 갱신
function updateCount(){
  countEl.textContent = "현재 연결 수: " + connections.length;
}

// 연결 모드 토글
toggleBtn.addEventListener("click", () => {
  connectMode = !connectMode;
  toggleBtn.textContent = "연결 모드: " + (connectMode ? "켜짐" : "꺼짐");
  // 모드 전환 시 선택 초기화
  selected = [];
  document.querySelectorAll(".placed").forEach(n => n.style.outline = "");
});

// Delete 키로 선택된 개념 삭제 (연결도 함께) + 패널 색상 복원
document.addEventListener("keydown", (e) => {
  if (e.key !== "Delete" && e.key !== "Backspace") return;
  if (selected.length === 0) return;

  const idsToRemove = [...selected];
  selected = [];

  idsToRemove.forEach(id => {
    const node = placed.find(p => p.id === id);
    if (!node) return;

    // 1) 이 노드와 연결된 선들을 먼저 DOM에서 제거
    const related = connections.filter(c => c.a === id || c.b === id);
    related.forEach(c => {
      const lineEl = svg.querySelector('line.connection[data-id="' + c.id + '"]');
      if (lineEl) lineEl.remove();
    });
    // 2) 연결 목록에서 제거
    connections = connections.filter(c => c.a !== id && c.b !== id);

    // 3) 노드 DOM 제거
    const div = canvas.querySelector('.placed[data-id="' + id + '"]');
    if (div) div.remove();

    // 4) 데이터에서 제거
    placed = placed.filter(p => p.id !== id);

    // 5) 사용 해제 → 패널에서 다시 활성화(회색 -> 파란색)
    used.delete(node.concept);
  });

  // 패널 갱신 + 연결 수 갱신
  renderPanel();
  updateCount();
});

// 초기화
resetBtn.addEventListener("click", () => {
  if (!confirm("모든 배치와 연결을 삭제할까요?")) return;
  placed = [];
  selected = [];
  connections = [];
  used = new Set();
  connId = 1;
  canvas.querySelectorAll(".placed").forEach(n => n.remove());
  while (svg.firstChild) svg.removeChild(svg.firstChild);
  renderPanel();
  updateCount();
});
</script>
</body>
</html>
